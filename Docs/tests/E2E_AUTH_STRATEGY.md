# E2Eãƒ†ã‚¹ãƒˆèªè¨¼æˆ¦ç•¥

Supabase Authã‚’ä½¿ç”¨ã™ã‚‹æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã§ã®E2Eãƒ†ã‚¹ãƒˆèªè¨¼æˆ¦ç•¥ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## âš ï¸ æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã§ã®èª²é¡Œ

### 1. **ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã®å•é¡Œ**

**èª²é¡Œ**:

- Supabaseã¯ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦
- ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’äº‹å‰ã«ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°/æœ¬ç•ªç’°å¢ƒã§ã¯æ‰‹å‹•ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãŒå¿…è¦

**å½±éŸ¿**:

- ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„ã¨ãƒ†ã‚¹ãƒˆãŒå¤±æ•—
- ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªå ´åˆã€è‡ªå‹•ãƒ†ã‚¹ãƒˆãŒå›°é›£
- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒè¤‡é›‘

### 2. **èªè¨¼ãƒ•ãƒ­ãƒ¼ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ**

**èª²é¡Œ**:

- æ¯å›ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨æ™‚é–“ãŒã‹ã‹ã‚‹ï¼ˆ10ç§’ä»¥ä¸Šï¼‰
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å¯èƒ½æ€§
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ã®å½±éŸ¿

**å½±éŸ¿**:

- E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ãŒé•·ããªã‚‹
- ãƒ†ã‚¹ãƒˆã®ä¿¡é ¼æ€§ãŒä½ä¸‹
- CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒé…ããªã‚‹

### 3. **ç’°å¢ƒã«ã‚ˆã‚‹å‹•ä½œã®é•ã„**

**èª²é¡Œ**:

- ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã¨ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§èªè¨¼ãƒ•ãƒ­ãƒ¼ãŒç•°ãªã‚‹
- ãƒ¡ãƒ¼ãƒ«ç¢ºèªã®æœ‰ç„¡
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®é•ã„

## âœ… æ¨å¥¨ã•ã‚Œã‚‹è§£æ±ºç­–

### è§£æ±ºç­–1: Playwright `storageState`ã®ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰â­

**æ¦‚è¦**:
ä¸€åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸèªè¨¼çŠ¶æ…‹ï¼ˆCookieã€LocalStorageï¼‰ã‚’ä¿å­˜ã—ã€å„ãƒ†ã‚¹ãƒˆã§å†åˆ©ç”¨ã—ã¾ã™ã€‚

**ãƒ¡ãƒªãƒƒãƒˆ**:

- âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã®å¤§å¹…çŸ­ç¸®ï¼ˆ10ç§’ â†’ 1ç§’ï¼‰
- âœ… ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å›é¿
- âœ… ãƒ†ã‚¹ãƒˆã®ä¿¡é ¼æ€§å‘ä¸Š
- âœ… ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå®¹æ˜“

**å®Ÿè£…æ–¹æ³•**:

#### Step 1: èªè¨¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

`tests/e2e/auth.setup.ts`ã§ä¸€åº¦ã ã‘ãƒ­ã‚°ã‚¤ãƒ³ï¼š

```typescript
import { test as setup } from '@playwright/test';

setup('authenticate', async ({ page }) => {
  await page.goto('/login');
  await page.fill('[name="email"]', 'test@example.com');
  await page.fill('[name="password"]', 'password123');
  await page.click('button[type="submit"]');
  await page.waitForURL('**/dashboard');

  // èªè¨¼çŠ¶æ…‹ã‚’ä¿å­˜
  await page.context().storageState({ path: '.auth/user.json' });
});
```

#### Step 2: Playwrightè¨­å®šã§ä¾å­˜é–¢ä¿‚ã‚’è¨­å®š

`playwright.config.ts`:

```typescript
projects: [
  { name: 'setup', testMatch: /.*\.setup\.ts/ },
  {
    name: 'chromium',
    use: {
      ...devices['Desktop Chrome'],
      storageState: '.auth/user.json', // ä¿å­˜ã—ãŸèªè¨¼çŠ¶æ…‹ã‚’ä½¿ç”¨
    },
    dependencies: ['setup'], // setupãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ä¾å­˜
  },
];
```

#### Step 3: å„ãƒ†ã‚¹ãƒˆã§èªè¨¼çŠ¶æ…‹ã‚’è‡ªå‹•ä½¿ç”¨

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒè‡ªå‹•çš„ã«èªè¨¼æ¸ˆã¿çŠ¶æ…‹ã§é–‹å§‹ã•ã‚Œã¾ã™ï¼

```typescript
test('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹', async ({ page }) => {
  // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼
  await page.goto('/dashboard');
  // ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰...
});
```

### è§£æ±ºç­–2: ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ†ã‚£ãƒƒã‚¯ä½œæˆ

**æ¦‚è¦**:
ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§Supabase APIã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

**å®Ÿè£…æ–¹æ³•**:

```typescript
// tests/e2e/global-setup.ts
import { createClient } from '@supabase/supabase-js';

async function globalSetup() {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY! // ç®¡ç†è€…ã‚­ãƒ¼
  );

  // ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  const { data, error } = await supabase.auth.admin.createUser({
    email: 'test@example.com',
    password: 'password123',
    email_confirm: true, // ãƒ¡ãƒ¼ãƒ«ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—
  });

  if (error && !error.message.includes('already exists')) {
    throw error;
  }

  console.log('âœ… Test user created/verified');
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:

- âœ… ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•ä½œæˆ
- âœ… ãƒ¡ãƒ¼ãƒ«ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—å¯èƒ½
- âœ… ãƒ†ã‚¹ãƒˆç’°å¢ƒã®å®Œå…¨è‡ªå‹•åŒ–

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:

- âŒ `SUPABASE_SERVICE_ROLE_KEY`ãŒå¿…è¦ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼‰
- âŒ æœ¬ç•ªç’°å¢ƒã§ã¯ä½¿ç”¨ã§ããªã„

### è§£æ±ºç­–3: ãƒ†ã‚¹ãƒˆå°‚ç”¨Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½¿ç”¨

**æ¦‚è¦**:
æœ¬ç•ª/ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã¨ã¯åˆ¥ã®ãƒ†ã‚¹ãƒˆå°‚ç”¨Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

**ãƒ¡ãƒªãƒƒãƒˆ**:

- âœ… æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ãªã—
- âœ… ãƒ¡ãƒ¼ãƒ«ç¢ºèªã‚’ç„¡åŠ¹åŒ–å¯èƒ½
- âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®¹æ˜“
- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã®ä½æ¸›

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:

- âŒ åˆ¥ã®Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå¿…è¦
- âŒ è¨­å®šã®æ‰‹é–“ãŒå¢—ãˆã‚‹

## ğŸ¯ CouplePlanã«æœ€é©ãªæˆ¦ç•¥

ä»¥ä¸‹ã®çµ„ã¿åˆã‚ã›ã‚’æ¨å¥¨ã—ã¾ã™ï¼š

### **ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®äº‹å‰ä½œæˆï¼ˆæ‰‹å‹• - 1å›ã®ã¿ï¼‰**

Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆï¼š

1. **ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼**
   - Email: `e2e-test@example.com`ï¼ˆã¾ãŸã¯å°‚ç”¨ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰
   - Password: `E2ETestPass123!`
   - ãƒ¡ãƒ¼ãƒ«ç¢ºèª: å®Œäº†ã•ã›ã‚‹

2. **ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼**
   - Email: `e2e-partner@example.com`
   - Password: `E2ETestPass123!`
   - ãƒ¡ãƒ¼ãƒ«ç¢ºèª: å®Œäº†ã•ã›ã‚‹

### **ã‚¹ãƒ†ãƒƒãƒ—2: `storageState`ã§èªè¨¼çŠ¶æ…‹ã‚’ä¿å­˜ãƒ»å†åˆ©ç”¨**

å®Ÿè£…æ¸ˆã¿ã®`tests/e2e/auth.setup.ts`ã‚’ä½¿ç”¨ï¼š

```bash
# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œï¼ˆèªè¨¼çŠ¶æ…‹ã‚’ä¿å­˜ï¼‰
npx playwright test tests/e2e/auth.setup.ts

# ä¿å­˜ã•ã‚ŒãŸèªè¨¼çŠ¶æ…‹ã§ä»–ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
npx playwright test tests/e2e/partner/ # èªè¨¼æ¸ˆã¿çŠ¶æ…‹ã§å®Ÿè¡Œ
```

### **ã‚¹ãƒ†ãƒƒãƒ—3: `.env.test`ã«å°‚ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¨­å®š**

```env
# E2Eå°‚ç”¨ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼
TEST_USER_EMAIL=e2e-test@example.com
TEST_USER_PASSWORD=E2ETestPass123!

# E2Eå°‚ç”¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼
TEST_PARTNER_EMAIL=e2e-partner@example.com
TEST_PARTNER_PASSWORD=E2ETestPass123!
```

## ğŸ“‹ å®Ÿè£…è¨ˆç”»

### Phase 1: èªè¨¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®å®Ÿè£…ï¼ˆã™ãã«å®Ÿæ–½ï¼‰

- [x] `tests/e2e/auth.setup.ts` ä½œæˆ âœ…
- [x] `tests/e2e/helpers/test-users.ts` ä½œæˆ âœ…
- [ ] `.auth/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
- [ ] `playwright.config.ts` ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šæ›´æ–°
- [ ] `.gitignore` ã« `.auth/` ã‚’è¿½åŠ 

### Phase 2: ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆï¼ˆæ‰‹å‹•ï¼‰

- [ ] Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
- [ ] ãƒ¡ãƒ¼ãƒ«ç¢ºèªã‚’å®Œäº†
- [ ] `.env.test` ã«èªè¨¼æƒ…å ±ã‚’è¨˜å…¥

### Phase 3: èªè¨¼çŠ¶æ…‹ã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆã®å®Ÿè£…

- [ ] èªè¨¼ãŒå¿…è¦ãªãƒ†ã‚¹ãƒˆã§ `storageState` ã‚’ä½¿ç”¨
- [ ] èªè¨¼ä¸è¦ãªãƒ†ã‚¹ãƒˆã¯é€šå¸¸é€šã‚Šå®Ÿè¡Œ

## ğŸ’¡ å®Ÿè£…ä¾‹

### èªè¨¼ãŒå¿…è¦ãªãƒ†ã‚¹ãƒˆ

```typescript
// tests/e2e/partner/invitation.spec.ts
import { test, expect } from '@playwright/test';

// ã“ã®ãƒ†ã‚¹ãƒˆã¯èªè¨¼æ¸ˆã¿çŠ¶æ…‹ã§å®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆstorageStateã‚’ä½¿ç”¨ï¼‰
test.describe('æ‹›å¾…ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ', () => {
  test('æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã§ãã‚‹', async ({ page }) => {
    // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼
    await page.goto('/dashboard/partner-linkage');

    // ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰...
  });
});
```

### èªè¨¼ãŒä¸è¦ãªãƒ†ã‚¹ãƒˆ

```typescript
// tests/e2e/auth/login.spec.ts
import { test, expect } from '@playwright/test';

// ã“ã®ãƒ†ã‚¹ãƒˆã¯èªè¨¼çŠ¶æ…‹ã‚’ä½¿ç”¨ã—ãªã„
test.use({ storageState: { cookies: [], origins: [] } }); // èªè¨¼ãªã—çŠ¶æ…‹

test.describe('ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½', () => {
  test('ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹', async ({ page }) => {
    await page.goto('/login');
    // ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰...
  });
});
```

## ğŸ”§ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ä»Šã™ãå®Ÿæ–½**: Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
   - `e2e-test@example.com` / `E2ETestPass123!`
   - `e2e-partner@example.com` / `E2ETestPass123!`
   - ãƒ¡ãƒ¼ãƒ«ç¢ºèªã‚’å®Œäº†

2. **`.env.test`ã‚’æ›´æ–°**:

   ```env
   TEST_USER_EMAIL=e2e-test@example.com
   TEST_USER_PASSWORD=E2ETestPass123!
   TEST_PARTNER_EMAIL=e2e-partner@example.com
   TEST_PARTNER_PASSWORD=E2ETestPass123!
   ```

3. **èªè¨¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ**:

   ```bash
   npx playwright test tests/e2e/auth.setup.ts
   ```

4. **ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ**ï¼ˆèªè¨¼çŠ¶æ…‹ãŒå†åˆ©ç”¨ã•ã‚Œã‚‹ï¼‰

ã“ã®æ–¹å¼ã«ã‚ˆã‚Šã€**æ¯å›ãƒ­ã‚°ã‚¤ãƒ³ã›ãšã«é«˜é€Ÿã§ä¿¡é ¼æ€§ã®é«˜ã„E2Eãƒ†ã‚¹ãƒˆãŒå®Ÿç¾**ã§ãã¾ã™ï¼

---

**å‚è€ƒè³‡æ–™**:

- [Playwright Authentication](https://playwright.dev/docs/auth)
- [Playwright storageState](https://playwright.dev/docs/api/class-browsercontext#browser-context-storage-state)
