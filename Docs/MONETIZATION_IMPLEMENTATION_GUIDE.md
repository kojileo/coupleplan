# ãƒãƒã‚¿ã‚¤ã‚ºæ©Ÿèƒ½å®Ÿè£…ã‚¬ã‚¤ãƒ‰

**ä½œæˆæ—¥**: 2025å¹´10æœˆ11æ—¥  
**å¯¾è±¡**: AIãƒ—ãƒ©ãƒ³ç”Ÿæˆåˆ¶é™æ©Ÿèƒ½ï¼ˆPhase 1.1 - Stripeé€£æºãªã—ï¼‰  
**å®Ÿè£…æœŸé–“**: 2-3é€±é–“  
**å‰ææ¡ä»¶**: èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã€AIãƒ—ãƒ©ãƒ³ç”Ÿæˆæ©Ÿèƒ½ãŒå®Ÿè£…æ¸ˆã¿

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [å®Ÿè£…ã®å…¨ä½“åƒ](#å®Ÿè£…ã®å…¨ä½“åƒ)
3. [Step 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿè£…](#step-1-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿè£…)
4. [Step 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIå®Ÿè£…](#step-2-ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰apiå®Ÿè£…)
5. [Step 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…](#step-3-ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…)
6. [Step 4: ãƒ†ã‚¹ãƒˆã¨èª¿æ•´](#step-4-ãƒ†ã‚¹ãƒˆã¨èª¿æ•´)
7. [ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †](#ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †)
8. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## æ¦‚è¦

### ç›®çš„

ç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼ˆFreeï¼‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ã€AIãƒ—ãƒ©ãƒ³ç”Ÿæˆã®åˆ©ç”¨å›æ•°åˆ¶é™ã‚’è¨­ã‘ã‚‹ã“ã¨ã§ï¼š

- APIè²»ç”¨ï¼ˆGemini APIï¼‰ã®ç®¡ç†
- å°†æ¥çš„ãªPremiumãƒ—ãƒ©ãƒ³ã¸ã®èª˜å°
- ã‚µãƒ¼ãƒ“ã‚¹ã®æŒç¶šå¯èƒ½æ€§ã®ç¢ºä¿

### ãƒ—ãƒ©ãƒ³è¨­å®š

| ãƒ—ãƒ©ãƒ³      | æ—¥æ¬¡åˆ¶é™ | æœˆæ¬¡åˆ¶é™ | ãƒ—ãƒ©ãƒ³ä¿å­˜æ•° | ä¾¡æ ¼                |
| ----------- | -------- | -------- | ------------ | ------------------- |
| **Free**    | 3å›/æ—¥   | 10å›/æœˆ  | 5ä»¶          | Â¥0                  |
| **Premium** | ç„¡åˆ¶é™   | ç„¡åˆ¶é™   | ç„¡åˆ¶é™       | Â¥480/æœˆï¼ˆå°†æ¥å®Ÿè£…ï¼‰ |

### åˆ¶é™ãƒ­ã‚¸ãƒƒã‚¯

- **æ—¥æ¬¡åˆ¶é™å„ªå…ˆ**: 1æ—¥3å›ã¾ã§
- **æœˆæ¬¡åˆ¶é™**: æœˆ10å›ã¾ã§ï¼ˆæ—¥æ¬¡ã‚’ä½¿ã„åˆ‡ã£ã¦ã‚‚ç¿Œæ—¥ã¾ãŸ3å›ï¼‰
- **ãƒªã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°**:
  - æ—¥æ¬¡: æ¯æ—¥0æ™‚ï¼ˆJSTï¼‰
  - æœˆæ¬¡: æ¯æœˆ1æ—¥0æ™‚ï¼ˆJSTï¼‰

---

## å®Ÿè£…ã®å…¨ä½“åƒ

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ UsageLimitDisplayâ”‚  â”‚ LimitReachedModalâ”‚            â”‚
â”‚  â”‚    (æ®‹ã‚Šå›æ•°è¡¨ç¤º)  â”‚  â”‚   (åˆ¶é™åˆ°é”æ™‚)    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                     â”‚                       â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                     â†“                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  /api/subscription/check-limit     â”‚ â† åˆ¶é™ãƒã‚§ãƒƒã‚¯  â”‚
â”‚  â”‚  /api/subscription/usage           â”‚ â† ä½¿ç”¨å±¥æ­´è¨˜éŒ²  â”‚
â”‚  â”‚  /api/subscription/current         â”‚ â† ãƒ—ãƒ©ãƒ³æƒ…å ±å–å¾—â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ subscription_plans                     â”‚            â”‚
â”‚  â”‚  - free: 3å›/æ—¥, 10å›/æœˆ               â”‚            â”‚
â”‚  â”‚  - premium: ç„¡åˆ¶é™                     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ user_subscriptions                     â”‚            â”‚
â”‚  â”‚  - user_id â†’ plan_id                   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ plan_generation_usage                  â”‚            â”‚
â”‚  â”‚  - user_id, generated_at               â”‚            â”‚
â”‚  â”‚  - generation_date (JST)               â”‚            â”‚
â”‚  â”‚  - generation_month (JST)              â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Ÿè£…ã®æµã‚Œ

```
Week 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿè£… (2-3æ—¥)
  â†“
Week 2: APIå®Ÿè£… (3-4æ—¥)
  â†“
Week 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£… (4-5æ—¥)
  â†“
Week 4: ãƒ†ã‚¹ãƒˆã¨èª¿æ•´ (2-3æ—¥)
```

---

## Step 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿè£…

### æ‰€è¦æ™‚é–“: 2-3æ—¥

### 1.1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
cat supabase/migrations/create_subscription_system.sql

# Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å®Ÿè¡Œ
# ã¾ãŸã¯
psql -h [your-supabase-host] -U postgres -d postgres -f supabase/migrations/create_subscription_system.sql
```

### 1.2 ä½œæˆã•ã‚Œã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«

#### `subscription_plans` - ãƒ—ãƒ©ãƒ³å®šç¾©

```sql
- id (UUID)
- name (TEXT): 'free', 'premium'
- display_name (TEXT): 'Free', 'Premium'
- price_monthly (INTEGER): 0, 480
- daily_plan_limit (INTEGER): 3, NULL
- monthly_plan_limit (INTEGER): 10, NULL
- max_saved_plans (INTEGER): 5, NULL
- features (JSONB)
- is_active (BOOLEAN)
- created_at, updated_at
```

#### `user_subscriptions` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µãƒ–ã‚¹ã‚¯çŠ¶æ…‹

```sql
- id (UUID)
- user_id (UUID) â†’ auth.users
- plan_id (UUID) â†’ subscription_plans
- status (TEXT): 'active', 'canceled', 'expired'
- stripe_customer_id (TEXT) -- å°†æ¥ç”¨
- stripe_subscription_id (TEXT) -- å°†æ¥ç”¨
- current_period_start, current_period_end
- cancel_at_period_end (BOOLEAN)
- created_at, updated_at
```

#### `plan_generation_usage` - ä½¿ç”¨å±¥æ­´

```sql
- id (UUID)
- user_id (UUID) â†’ auth.users
- plan_id (UUID) â†’ date_plans
- generated_at (TIMESTAMPTZ)
- generation_date (DATE) -- JSTåŸºæº–ã€è‡ªå‹•ç”Ÿæˆ
- generation_month (DATE) -- JSTåŸºæº–ã€è‡ªå‹•ç”Ÿæˆ
```

### 1.3 å‹•ä½œç¢ºèª

```sql
-- ãƒ—ãƒ©ãƒ³ãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
SELECT * FROM subscription_plans;
-- æœŸå¾…å€¤: free ã¨ premium ã®2ãƒ¬ã‚³ãƒ¼ãƒ‰

-- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«Freeãƒ—ãƒ©ãƒ³ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
SELECT
  u.email,
  sp.name AS plan_name,
  us.status
FROM auth.users u
JOIN user_subscriptions us ON u.id = us.user_id
JOIN subscription_plans sp ON us.plan_id = sp.id;

-- ãƒˆãƒªã‚¬ãƒ¼ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ç¢ºèª
-- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¦ã€è‡ªå‹•çš„ã«Freeãƒ—ãƒ©ãƒ³ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
```

---

## Step 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIå®Ÿè£…

### æ‰€è¦æ™‚é–“: 3-4æ—¥

### 2.1 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
src/app/api/subscription/
â”œâ”€â”€ check-limit/
â”‚   â””â”€â”€ route.ts      # åˆ¶é™ãƒã‚§ãƒƒã‚¯API
â”œâ”€â”€ usage/
â”‚   â””â”€â”€ route.ts      # ä½¿ç”¨å±¥æ­´è¨˜éŒ²API
â””â”€â”€ current/
    â””â”€â”€ route.ts      # ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³å–å¾—API
```

### 2.2 å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

#### `/api/subscription/check-limit/route.ts`

**æ©Ÿèƒ½**: ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAIãƒ—ãƒ©ãƒ³ç”Ÿæˆå¯èƒ½ã‹ã‚’ãƒã‚§ãƒƒã‚¯

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:

```json
{
  "canGenerate": true,
  "remaining": {
    "daily": 2,
    "monthly": 8
  },
  "used": {
    "daily": 1,
    "monthly": 2
  },
  "limits": {
    "daily": 3,
    "monthly": 10
  },
  "plan": "free"
}
```

å®Ÿè£…å†…å®¹ã¯`Docs/é–‹ç™ºè¨ˆç”».md`ã®ã€ŒStep 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIå®Ÿè£…ã€ã‚’å‚ç…§ã€‚

#### `/api/subscription/usage/route.ts`

**æ©Ÿèƒ½**: AIãƒ—ãƒ©ãƒ³ç”Ÿæˆå¾Œã«ä½¿ç”¨å±¥æ­´ã‚’è¨˜éŒ²

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:

```json
{
  "planId": "uuid-of-generated-plan" // optional
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:

```json
{
  "success": true,
  "canGenerate": true,
  "remaining": {
    "daily": 1,
    "monthly": 7
  }
}
```

#### `/api/subscription/current/route.ts`

**æ©Ÿèƒ½**: ç¾åœ¨ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:

```json
{
  "subscription": {
    "id": "uuid",
    "status": "active",
    "created_at": "2025-10-11T00:00:00Z"
  },
  "plan": {
    "name": "free",
    "display_name": "Free",
    "price_monthly": 0,
    "daily_plan_limit": 3,
    "monthly_plan_limit": 10,
    "features": {...}
  }
}
```

### 2.3 å‹•ä½œç¢ºèª

```bash
# åˆ¶é™ãƒã‚§ãƒƒã‚¯
curl -X GET http://localhost:3000/api/subscription/check-limit \
  -H "Cookie: your-session-cookie"

# ä½¿ç”¨å±¥æ­´è¨˜éŒ²
curl -X POST http://localhost:3000/api/subscription/usage \
  -H "Content-Type: application/json" \
  -H "Cookie: your-session-cookie" \
  -d '{"planId": "test-plan-id"}'

# ãƒ—ãƒ©ãƒ³æƒ…å ±å–å¾—
curl -X GET http://localhost:3000/api/subscription/current \
  -H "Cookie: your-session-cookie"
```

---

## Step 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### æ‰€è¦æ™‚é–“: 4-5æ—¥

### 3.1 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
src/components/subscription/
â”œâ”€â”€ UsageLimitDisplay.tsx     # æ®‹ã‚Šå›æ•°è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”œâ”€â”€ LimitReachedModal.tsx     # åˆ¶é™åˆ°é”ãƒ¢ãƒ¼ãƒ€ãƒ«
â””â”€â”€ SubscriptionBadge.tsx     # ãƒ—ãƒ©ãƒ³ãƒãƒƒã‚¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```

### 3.2 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…

#### `UsageLimitDisplay.tsx`

**é…ç½®å ´æ‰€**: AIãƒ—ãƒ©ãƒ³ä½œæˆç”»é¢ï¼ˆ`/dashboard/plans/create`ï¼‰

**è¡¨ç¤ºå†…å®¹**:

- ä»Šæ—¥ã®æ®‹ã‚Šå›æ•°: X / 3å›
- ä»Šæœˆã®æ®‹ã‚Šå›æ•°: Y / 10å›
- Premiumæ¡ˆå†…ãƒªãƒ³ã‚¯

**å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ**:

- useEffectã§åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã«`/api/subscription/check-limit`ã‚’å‘¼ã³å‡ºã—
- Premiumãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯è¡¨ç¤ºã—ãªã„ï¼ˆplan === 'premium'ã®å ´åˆï¼‰
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è¡¨ç¤º

#### `LimitReachedModal.tsx`

**é…ç½®å ´æ‰€**: AIãƒ—ãƒ©ãƒ³ä½œæˆç”»é¢ï¼ˆåˆ¶é™åˆ°é”æ™‚ã«è¡¨ç¤ºï¼‰

**è¡¨ç¤ºå†…å®¹**:

- æ—¥æ¬¡åˆ¶é™åˆ°é”æ™‚: "æ˜æ—¥ã¾ãŸ3å›ä½œæˆã§ãã¾ã™"
- æœˆæ¬¡åˆ¶é™åˆ°é”æ™‚: "æ¥æœˆã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™"
- Premiumæ¡ˆå†…ï¼ˆè©³ç´°ãƒœã‚¿ãƒ³ â†’ å°†æ¥çš„ã«ç™»éŒ²ãƒšãƒ¼ã‚¸ã¸ï¼‰

**å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ**:

- isOpen, onClose, limitType, remaining ã‚’propsã§å—ã‘å–ã‚‹
- èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
- ESCã‚­ãƒ¼ã§é–‰ã˜ã‚‹

### 3.3 AIãƒ—ãƒ©ãƒ³ç”Ÿæˆãƒ•ãƒ­ãƒ¼ã¸ã®çµ±åˆ

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/dashboard/plans/create/page.tsx`

**ä¿®æ­£ç®‡æ‰€**: ãƒ—ãƒ©ãƒ³ç”Ÿæˆãƒœã‚¿ãƒ³ã®onClickå‡¦ç†

```typescript
const handleGeneratePlan = async () => {
  // 1. åˆ¶é™ãƒã‚§ãƒƒã‚¯
  const limitResponse = await fetch('/api/subscription/check-limit');
  const limitData = await limitResponse.json();

  if (!limitData.canGenerate) {
    // åˆ¶é™åˆ°é”ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const limitType = limitData.remaining.daily === 0 ? 'daily' : 'monthly';
    setShowLimitModal(true);
    setLimitType(limitType);
    setRemaining(limitData.remaining);
    return;
  }

  // 2. ãƒ—ãƒ©ãƒ³ç”Ÿæˆå‡¦ç†ï¼ˆæ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ï¼‰
  setGenerating(true);
  try {
    const response = await fetch('/api/plans/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData),
    });

    const data = await response.json();

    // 3. ä½¿ç”¨å±¥æ­´ã‚’è¨˜éŒ² â† NEW
    await fetch('/api/subscription/usage', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ planId: data.plan.id }),
    });

    // 4. ç”Ÿæˆå®Œäº†å‡¦ç†
    router.push(`/dashboard/plans/${data.plan.id}`);
  } catch (error) {
    console.error('Error generating plan:', error);
  } finally {
    setGenerating(false);
  }
};
```

### 3.4 ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ã®çµ±åˆ

**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**: `src/app/dashboard/page.tsx`

**è¿½åŠ å†…å®¹**: ä½¿ç”¨çŠ¶æ³ã®è¡¨ç¤º

```tsx
import { UsageLimitDisplay } from '@/components/subscription/UsageLimitDisplay';

export default function Dashboard() {
  return (
    <div>
      {/* æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}

      {/* ä½¿ç”¨çŠ¶æ³è¡¨ç¤º */}
      <UsageLimitDisplay />

      {/* æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
    </div>
  );
}
```

---

## Step 4: ãƒ†ã‚¹ãƒˆã¨èª¿æ•´

### æ‰€è¦æ™‚é–“: 2-3æ—¥

### 4.1 ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

#### åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ

- [ ] æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ™‚ã«Freeãƒ—ãƒ©ãƒ³ãŒè‡ªå‹•å‰²ã‚Šå½“ã¦ã•ã‚Œã‚‹
- [ ] æ—¥æ¬¡åˆ¶é™ï¼ˆ3å›ï¼‰ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹
  - 1å›ç›®ã€2å›ç›®ã€3å›ç›®ã®ç”ŸæˆãŒæˆåŠŸ
  - 4å›ç›®ã®ç”Ÿæˆæ™‚ã«åˆ¶é™ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] æœˆæ¬¡åˆ¶é™ï¼ˆ10å›ï¼‰ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹
  - æ—¥ã‚’ã¾ãŸã„ã§åˆè¨ˆ10å›ã¾ã§ç”Ÿæˆå¯èƒ½
  - 11å›ç›®ã§åˆ¶é™ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] æ®‹ã‚Šå›æ•°ã®è¡¨ç¤ºãŒæ­£ã—ã„
  - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã‚‹
  - ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã‚‚æ­£ã—ã„å€¤ãŒè¡¨ç¤ºã•ã‚Œã‚‹

#### ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ

- [ ] æ—¥ä»˜å¤‰æ›´æ™‚ï¼ˆ0æ™‚JSTï¼‰ã«æ—¥æ¬¡ã‚«ã‚¦ãƒ³ãƒˆãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹
  - 23:59ã«3å›ä½¿ã„åˆ‡ã‚‹
  - 0:00ã«ãªã£ãŸã‚‰å†åº¦3å›ä½¿ãˆã‚‹
- [ ] æœˆåˆï¼ˆ1æ—¥0æ™‚JSTï¼‰ã«æœˆæ¬¡ã‚«ã‚¦ãƒ³ãƒˆãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹
  - æœˆæœ«ã«10å›ä½¿ã„åˆ‡ã‚‹
  - æœˆåˆã«ãªã£ãŸã‚‰å†åº¦10å›ä½¿ãˆã‚‹

#### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ

- [ ] ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å‡¦ç†ï¼ˆJSTåŸºæº–ï¼‰ãŒæ­£ã—ã„
  - ã‚µãƒ¼ãƒãƒ¼ãŒUTCã§ã‚‚æ­£ã—ãJSTã§åˆ¤å®šã•ã‚Œã‚‹
- [ ] åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†
  - 2ã¤ã®ã‚¿ãƒ–ã§åŒæ™‚ã«ç”Ÿæˆã—ã¦ã‚‚æ­£ã—ãã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹
  - ç«¶åˆçŠ¶æ…‹ã«ãªã‚‰ãªã„
- [ ] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒªãƒˆãƒ©ã‚¤
  - APIã‚¨ãƒ©ãƒ¼æ™‚ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹
  - ãƒªãƒˆãƒ©ã‚¤å¯èƒ½
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼å‡¦ç†
  - Graceful degradation
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é©åˆ‡ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

- [ ] å¤§é‡ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ³å®šã®ãƒ†ã‚¹ãƒˆ
  - 1000ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ  < 500ms
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åŠ¹æœ
  - generation_date, generation_monthã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã„ã¦ã„ã‚‹
  - EXPLAIN ANALYZEã§ç¢ºèª

### 4.2 ãƒ†ã‚¹ãƒˆæ‰‹é †

```bash
# 1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ
npm run dev

# 2. æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
# â†’ Freeãƒ—ãƒ©ãƒ³ãŒè‡ªå‹•å‰²ã‚Šå½“ã¦ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

# 3. AIãƒ—ãƒ©ãƒ³ç”Ÿæˆã‚’3å›å®Ÿè¡Œ
# â†’ æ®‹ã‚Šå›æ•°ãŒæ­£ã—ãæ¸›ã‚‹ã“ã¨ã‚’ç¢ºèª

# 4. 4å›ç›®ã®ç”Ÿæˆã‚’è©¦ã¿ã‚‹
# â†’ åˆ¶é™ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

# 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ç¢ºèª
psql -c "SELECT * FROM plan_generation_usage WHERE user_id = 'your-user-id'"

# 6. æ™‚é–“ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
# â†’ generation_dateã‚’æ‰‹å‹•ã§å¤‰æ›´ã—ã¦æ—¥ä»˜ãƒªã‚»ãƒƒãƒˆã‚’ãƒ†ã‚¹ãƒˆ
```

### 4.3 ãƒã‚°ä¿®æ­£ã¨ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

- [ ] ç™ºè¦‹ã•ã‚ŒãŸãƒã‚°ã®ä¿®æ­£
- [ ] UXã®æ”¹å–„
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ”¹å–„

---

## ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### 5.1 Supabaseæœ¬ç•ªç’°å¢ƒ

```bash
# 1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æœ¬ç•ªç’°å¢ƒã§å®Ÿè¡Œ
# Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ SQL Editor â†’ New query
# create_subscription_system.sql ã®å†…å®¹ã‚’ãƒšãƒ¼ã‚¹ãƒˆ â†’ Run

# 2. RLSãƒãƒªã‚·ãƒ¼ã®ç¢ºèª
# Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ Authentication â†’ Policies
# subscription_plans, user_subscriptions, plan_generation_usage ã®ãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèª

# 3. ãƒˆãƒªã‚¬ãƒ¼ã®å‹•ä½œç¢ºèª
# ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¦ã€Freeãƒ—ãƒ©ãƒ³ãŒè‡ªå‹•å‰²ã‚Šå½“ã¦ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
```

### 5.2 Vercelæœ¬ç•ªç’°å¢ƒ

```bash
# 1. ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
# NEXT_PUBLIC_SUPABASE_URL
# NEXT_PUBLIC_SUPABASE_ANON_KEY
# SUPABASE_SERVICE_ROLE_KEY
# GEMINI_API_KEY

# 2. ãƒ‡ãƒ—ãƒ­ã‚¤
vercel --prod

# 3. å‹•ä½œç¢ºèª
# æœ¬ç•ªç’°å¢ƒã§ãƒ—ãƒ©ãƒ³ç”Ÿæˆã‚’å®Ÿè¡Œ
# åˆ¶é™æ©Ÿèƒ½ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
```

### 5.3 ç›£è¦–è¨­å®š

```bash
# 1. Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä½¿ç”¨çŠ¶æ³ã‚’ç›£è¦–
# Database â†’ Logs
# plan_generation_usage ãƒ†ãƒ¼ãƒ–ãƒ«ã®æŒ¿å…¥ãƒ­ã‚°ã‚’ç¢ºèª

# 2. Vercelã§ APIã‚¨ãƒ©ãƒ¼ã‚’ç›£è¦–
# Vercel Dashboard â†’ Logs
# /api/subscription/* ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª

# 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®åé›†
# ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã€ã‚¢ãƒ—ãƒªå†…ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«Freeãƒ—ãƒ©ãƒ³ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œãªã„

**åŸå› **: ãƒˆãƒªã‚¬ãƒ¼ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ãªã„

**è§£æ±ºç­–**:

```sql
-- ãƒˆãƒªã‚¬ãƒ¼ã®ç¢ºèª
SELECT * FROM pg_trigger WHERE tgname = 'on_auth_user_created';

-- ãƒˆãƒªã‚¬ãƒ¼ã®å†ä½œæˆ
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION create_user_subscription();
```

### å•é¡Œ2: æ—¥æ¬¡/æœˆæ¬¡ã®ãƒªã‚»ãƒƒãƒˆãŒæ­£ã—ãå‹•ä½œã—ãªã„

**åŸå› **: ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å‡¦ç†ãŒæ­£ã—ããªã„

**è§£æ±ºç­–**:

```sql
-- generation_date, generation_monthã®å€¤ã‚’ç¢ºèª
SELECT
  user_id,
  generated_at,
  generation_date,
  generation_month
FROM plan_generation_usage
ORDER BY generated_at DESC
LIMIT 10;

-- JSTã§æ­£ã—ãè¨ˆç®—ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
SELECT
  now() AS utc_now,
  now() AT TIME ZONE 'Asia/Tokyo' AS jst_now,
  DATE(now() AT TIME ZONE 'Asia/Tokyo') AS jst_date;
```

### å•é¡Œ3: åˆ¶é™ãŒæ­£ã—ãã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œãªã„

**åŸå› **: `/api/subscription/usage`ãŒå‘¼ã°ã‚Œã¦ã„ãªã„

**è§£æ±ºç­–**:

- ãƒ—ãƒ©ãƒ³ç”Ÿæˆãƒ•ãƒ­ãƒ¼ï¼ˆ`handleGeneratePlan`ï¼‰ã‚’ç¢ºèª
- ä½¿ç”¨å±¥æ­´è¨˜éŒ²ã®å‘¼ã³å‡ºã—ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã§APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèª

### å•é¡Œ4: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ‚ªã„

**åŸå› **: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã„ã¦ã„ãªã„

**è§£æ±ºç­–**:

```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ç¢ºèª
SELECT * FROM pg_indexes
WHERE tablename = 'plan_generation_usage';

-- å®Ÿè¡Œè¨ˆç”»ã®ç¢ºèª
EXPLAIN ANALYZE
SELECT COUNT(*)
FROM plan_generation_usage
WHERE user_id = 'test-user-id'
AND generation_date = CURRENT_DATE;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å†ä½œæˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
REINDEX TABLE plan_generation_usage;
```

---

## å‚è€ƒè³‡æ–™

- **ãƒ“ã‚¸ãƒã‚¹è¦ä»¶å®šç¾©æ›¸**: `Docs/design/ãƒ“ã‚¸ãƒã‚¹è¦ä»¶å®šç¾©æ›¸.md` - ã‚»ã‚¯ã‚·ãƒ§ãƒ³6.7
- **é–‹ç™ºè¨ˆç”»æ›¸**: `Docs/é–‹ç™ºè¨ˆç”».md` - ãƒãƒã‚¿ã‚¤ã‚ºæ©Ÿèƒ½å®Ÿè£…è¨ˆç”»
- **UC-007ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹**: `Docs/usecase/UC-007_æ®µéšçš„ãƒãƒã‚¿ã‚¤ã‚ºåˆ¶å¾¡.md`
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/migrations/create_subscription_system.sql`

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆPhase 1.2ä»¥é™ï¼‰

Phase 1.1å®Œäº†å¾Œã€6-12ãƒ¶æœˆå¾Œã«å®Ÿè£…äºˆå®š:

- [ ] Stripeé€£æºå®Ÿè£…
- [ ] Premiumä¼šå“¡ç™»éŒ²æ©Ÿèƒ½
- [ ] ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ç”»é¢
- [ ] æ±ºæ¸ˆå±¥æ­´è¡¨ç¤º
- [ ] ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ©Ÿèƒ½
- [ ] ä¸­é–“ãƒ—ãƒ©ãƒ³ï¼ˆLite Â¥300/æœˆï¼‰ã®è¿½åŠ æ¤œè¨

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ11æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**ä½œæˆè€…**: é–‹ç™ºãƒãƒ¼ãƒ 
