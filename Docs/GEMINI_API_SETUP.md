# Google Gemini API セットアップガイド

## 概要

このガイドでは、CouplePlanアプリケーションにGoogle Gemini APIを統合する手順を説明します。

Gemini APIの無料利用枠:

- **1分間あたり**: 15リクエスト
- **1日あたり**: 1,500リクエスト
- **月間推定**: 45,000リクエスト
- **コスト**: 完全無料

## セットアップ手順

### Step 1: Google AI Studio でAPIキーを取得

1. [Google AI Studio](https://aistudio.google.com/) にアクセス
2. Googleアカウントでログイン
3. 左メニューから「Get API key」をクリック
4. 「Create API key」ボタンをクリック
5. 既存のGCPプロジェクトを選択するか、新規作成
6. APIキーが生成されたらコピー

### Step 2: 環境変数を設定

プロジェクトルートに `.env.local` ファイルを作成（または編集）:

```env
# AI Provider Configuration
AI_PROVIDER=gemini

# Google Gemini API Key
GEMINI_API_KEY=your_gemini_api_key_here

# Model Configuration
AI_MODEL=gemini-pro
AI_MAX_TOKENS=2000
AI_TEMPERATURE=0.7
```

**重要**: `.env.local` は `.gitignore` に含まれているため、Gitにコミットされません。

### Step 3: 動作確認

1. 開発サーバーを起動:

   ```bash
   npm run dev
   ```

2. ブラウザで `http://localhost:3000/dashboard/plans/create` にアクセス

3. デートプラン作成フォームに入力して「プランを生成」をクリック

4. AI生成が成功すれば、3つのプランが提案されます

### Step 4: 本番環境へのデプロイ

Vercelの場合:

1. Vercelダッシュボードにアクセス
2. プロジェクトの「Settings」→「Environment Variables」
3. 以下の環境変数を追加:
   - `AI_PROVIDER`: `gemini`
   - `GEMINI_API_KEY`: (Google AI Studioで取得したAPIキー)
   - `AI_MODEL`: `gemini-pro`
   - `AI_MAX_TOKENS`: `2000`
   - `AI_TEMPERATURE`: `0.7`

4. プロジェクトを再デプロイ

## 利用可能なモデル

### gemini-pro (推奨)

- テキスト生成に最適
- 高品質な日本語対応
- 無料利用枠あり

### gemini-pro-vision

- 画像とテキストの両方を処理可能
- 将来の画像分析機能に使用予定

## 安全機能

実装されている安全機能:

### 1. レート制限管理

- **キューイングシステム**: リクエストを順序通りに処理
- **自動待機**: レート制限に達した場合は自動的に待機
- **1日制限監視**: 1日1,500リクエストを超えた場合はエラー

### 2. 多重リクエスト防止

- **リクエストID管理**: 各リクエストに一意のIDを割り当て
- **重複チェック**: 同じIDのリクエストは同時に実行されない
- **processingフラグ**: キュー処理の多重実行を防止

### 3. 安全なリトライロジック

- **最大リトライ回数**: 3回まで（無限ループ防止）
- **指数バックオフ**: リトライ間隔を徐々に増加
- **リトライ可能エラーの判定**: レート制限、サーバーエラー、タイムアウトのみリトライ

### 4. タイムアウト設定

- **リクエストタイムアウト**: 25秒
- **キュータイムアウト**: 30秒
- タイムアウトを超えたリクエストは自動的にキャンセル

### 5. エラーハンドリング

- **詳細なエラー分類**: MISSING_API_KEY, RATE_LIMIT_ERROR, TIMEOUT_ERROR等
- **ユーザーフレンドリーなエラーメッセージ**
- **エラーログ**: デバッグ用の詳細情報を記録

## トラブルシューティング

### エラー: "Gemini APIキーが設定されていません"

**原因**: 環境変数 `GEMINI_API_KEY` が設定されていない

**解決策**:

1. `.env.local` ファイルに `GEMINI_API_KEY` を追加
2. 開発サーバーを再起動 (`npm run dev`)

### エラー: "レート制限に達しました"

**原因**: 無料利用枠の制限超過

- 1分間に15リクエスト以上
- 1日に1,500リクエスト以上

**解決策**:

1. しばらく待ってから再試行（自動的にキューに入ります）
2. レート制限マネージャーが自動的に待機します
3. 1日の制限に達した場合は翌日まで待機

### エラー: "レスポンスがトークン制限に達しました"（MAX_TOKENS）

**原因**: `AI_MAX_TOKENS` の設定値が小さすぎる

**症状**:

```
finishReason: "MAX_TOKENS"
使用トークン: 2305
```

**解決策**:

1. **`.env.local` でトークン数を増やす**:

   ```env
   AI_MAX_TOKENS=8000
   ```

2. **開発サーバーを再起動**:

   ```bash
   # Ctrl + C でサーバーを停止
   npm run dev
   ```

3. **トークン数の推奨値**:
   - **最小値**: `4000`
   - **推奨値**: `8000` ⭐
   - **最大値**: `32768`（gemini-1.5-proの場合）

4. **注意事項**:
   - トークン数 = プロンプト + レスポンス
   - 大きなプロンプト（複雑な要望）は多くのトークンを消費
   - デフォルト値を `2000` から `8000` に変更済み

### エラー: "Gemini APIエンドポイントが見つかりません（404）"

**原因**: モデル名が正しくない、またはAPIキーが無効

**解決策**:

1. **環境変数を確認**:

   ```env
   AI_MODEL=gemini-1.5-pro-latest
   ```

   または

   ```env
   AI_MODEL=gemini-pro
   ```

2. **利用可能なモデル名**:
   - ✅ `gemini-1.5-pro-latest` (推奨)
   - ✅ `gemini-1.5-flash-latest` (高速版)
   - ✅ `gemini-pro` (レガシー)
   - ❌ `gpt-4` (OpenAI用)
   - ❌ `claude-3` (Anthropic用)

3. **APIキーを確認**:
   - Google AI Studio で生成したキーか確認
   - キーが有効期限内か確認
   - キーに余計な空白や改行が含まれていないか確認

4. **デバッグ情報を確認**:
   ターミナルに出力される詳細なエラーメッセージを確認

### エラー: "リクエストがタイムアウトしました"

**原因**:

- トークン数が多く、生成に時間がかかる（8000トークン）
- ネットワークの遅延
- Gemini APIの応答遅延

**解決策**:

1. **修正済み**: タイムアウト時間を延長
   - Gemini API: 60秒
   - レート制限マネージャー: 90秒
   - 自動リトライ: 最大2回

2. **修正済み**: プラン生成数を最適化
   - 3つのプラン → 1つの最適プランに変更
   - 生成時間: 30-50秒 → 15-25秒に短縮
   - トークン使用量: 約50-60%削減

3. **それでもタイムアウトする場合**:
   - トークン数を減らす:
     ```env
     AI_MAX_TOKENS=6000
     ```
   - 高速モデルに変更:
     ```env
     AI_MODEL=gemini-1.5-flash-latest
     ```

4. **ネットワークを確認**:
   - インターネット速度をテスト
   - VPN使用時は切断してみる
   - ファイアウォール設定を確認

5. **プロンプトを短くする**:
   - 「特別な要望」を簡潔に
   - 好みタグを5個以下に
   - 所要時間を短めに設定

### エラー: "リクエストID xxx は既に実行中です"

**原因**: 同じリクエストが重複して送信された（通常は発生しません）

**解決策**:

1. これは正常な動作です（多重リクエスト防止機能）
2. 前のリクエストが完了するまで待機
3. 問題が続く場合はページをリロード

## モニタリング

レート制限の統計情報を確認するには、以下のコードを使用:

```typescript
import { getRateLimiter } from '@/lib/rate-limiter';

const limiter = getRateLimiter();
const stats = limiter.getStats();

console.log('統計情報:', {
  今分のリクエスト数: stats.minuteRequests,
  今日のリクエスト数: stats.dayRequests,
  キューの長さ: stats.queueLength,
  アクティブなリクエスト: stats.activeRequests,
});
```

## ベストプラクティス

### 1. APIキーの管理

- ✅ 環境変数で管理
- ✅ `.gitignore` で除外
- ✅ 本番環境は別のAPIキーを使用
- ❌ コード内にハードコードしない

### 2. レート制限の管理

- ✅ シングルトンのRateLimiterを使用
- ✅ キューイングシステムを活用
- ✅ 統計情報をモニタリング
- ❌ 直接API呼び出しを行わない

### 3. エラーハンドリング

- ✅ ユーザーフレンドリーなエラーメッセージ
- ✅ リトライ可能なエラーは自動リトライ
- ✅ エラーログを記録
- ❌ エラーを無視しない

### 4. パフォーマンス

- ✅ タイムアウトを設定
- ✅ 並列処理は避ける（キューイング）
- ✅ 不要なリクエストを削減
- ❌ 無限ループやリトライを作らない

## よくある質問

### Q1: Gemini APIの料金は？

**A**: 無料利用枠内（1分間15リクエスト、1日1,500リクエスト）であれば完全無料です。

### Q2: 無料枠を超えた場合は？

**A**: 自動的にリクエストがキューに入り、レート制限内で順次処理されます。1日の制限を超えた場合は翌日まで待機が必要です。

### Q3: OpenAIやClaudeに切り替えできる？

**A**: はい、環境変数 `AI_PROVIDER` を変更するだけで切り替え可能です。

### Q4: レート制限マネージャーは必須？

**A**: はい、多重リクエストやループを防ぐために必須です。直接API呼び出しは行わないでください。

### Q5: 本番環境で問題が発生した場合は？

**A**:

1. Vercelのログを確認
2. 環境変数が正しく設定されているか確認
3. Gemini APIのステータスページを確認
4. モックプロバイダー（`AI_PROVIDER=mock`）で動作確認

## 参考リンク

- [Google AI Studio](https://aistudio.google.com/)
- [Gemini API Documentation](https://ai.google.dev/docs)
- [Gemini API Pricing](https://ai.google.dev/pricing)
- [API Status Page](https://status.cloud.google.com/)

## サポート

問題が発生した場合は、以下の情報を含めて報告してください:

1. エラーメッセージ
2. 発生した状況
3. レート制限統計情報（`limiter.getStats()`）
4. 環境（開発/本番）
5. 使用しているモデル

---

**最終更新**: 2025年10月9日  
**バージョン**: 1.0
