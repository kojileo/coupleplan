# Couple Plan テスト戦略

このプロジェクトでは、以下の2つのレベルでテストを実施しています：

## 1. ユニットテスト (`tests/unit/`)

個々のコンポーネントや関数の動作を検証するテストです。

- **対象**: 関数、コンポーネント、ユーティリティ
- **ツール**: Jest, React Testing Library
- **実行コマンド**: `npm run test:unit`

## 2. インテグレーションテスト (`tests/integration/`)

複数のコンポーネントやAPIの連携、およびフロントエンドの動作を検証するテストです。

- **対象**:
  - APIエンドポイント
  - 複合コンポーネント
  - データフロー
  - ユーザーインターフェース
  - フォーム検証
  - 画面遷移
  - 静的ページ（About、FAQ、Terms、Privacy、Contact）
- **ツール**: Jest, React Testing Library, Fetch Mock, jsdom
- **実行コマンド**: `npm run test:integration`

## テストカバレッジ（ページ別）

### 静的ページのテストカバレッジ

以下のページが完全にテストされています：

1. **ホームページ** (`tests/integration/pages/home.test.tsx`)

   - ナビゲーションヘッダー
   - メインコンテンツ（タイトル、説明、機能紹介）
   - 特徴セクション（4つの主要機能）
   - 利用の流れセクション（4ステップ）
   - 拡張されたフッター（サービス、サポート、アカウントリンク）
   - ログイン状態別の動作
   - レスポンシブ対応とアクセシビリティ

2. **サービス紹介ページ** (`tests/integration/pages/about.test.tsx`)

   - ページタイトルとサービス説明
   - 主な機能セクション（プラン作成、共有、公開プラン閲覧）
   - 推奨カップルセクション
   - 安全性とプライバシーセクション
   - 行動促進セクション（CTA）
   - ナビゲーションリンクの検証

3. **よくある質問ページ** (`tests/integration/pages/faq.test.tsx`)

   - カテゴリ別FAQ構成
   - Q&A形式の構造検証
   - 各カテゴリの内容確認（アカウント、デートプラン、プライバシー、技術、機能）
   - お問い合わせ促進セクション
   - アクセシビリティ対応

4. **利用規約ページ** (`tests/integration/pages/terms.test.tsx`)

   - 全14条の利用規約
   - 法的文書の構造検証
   - 禁止事項の詳細
   - 個人情報保護条項
   - 準拠法と管轄裁判所
   - リンク構造の検証

5. **プライバシーポリシーページ** (`tests/integration/pages/privacy.test.tsx`)

   - 個人情報の取り扱い
   - Google AdSense関連の記載
   - Google Analytics関連の記載
   - お問い合わせ関連の記載
   - 外部リンクの検証

6. **お問い合わせページ** (`tests/integration/pages/contact.test.tsx`)
   - フォーム検証
   - 送信機能のテスト
   - バリデーション機能
   - エラーハンドリング
   - 成功時の挙動

## テスト実行方法

### ローカル環境での実行

```bash
# すべてのテストを実行
npm run test

# ユニットテストのみ実行
npm run test:unit

# インテグレーションテストのみ実行
npm run test:integration

# 特定のページのテストのみ実行
npm run test -- tests/integration/pages/home.test.tsx
npm run test -- tests/integration/pages/about.test.tsx
npm run test -- tests/integration/pages/faq.test.tsx
npm run test -- tests/integration/pages/terms.test.tsx
```

### CI環境での実行

GitHub Actionsで自動的に実行されます。各テストタイプは別々のジョブとして実行され、並列処理されます。

## テストカバレッジ

テストカバレッジレポートを生成するには：

```bash
npm run test:coverage
```

インテグレーションテストでは自動的にカバレッジレポートが生成されます：

```bash
npm run test:integration
```

## モックの使用方法

テストでは以下のモックを使用しています：

1. **APIモック**: `jest-fetch-mock`を使用してAPIリクエストをモック化
2. **Supabaseモック**: 認証機能をモック化
3. **Prismaモック**: データベース操作をモック化
4. **jsdomモック**: ブラウザ環境をシミュレート
5. **Next.jsモック**: ナビゲーションとリンクコンポーネント

## 静的ページテスト戦略

新しく追加された静的ページ（About、FAQ、Terms）では、以下の観点でテストを実装しています：

1. **コンテンツ検証**:

   - ページタイトルと主要セクションの表示確認
   - 重要なテキストコンテンツの存在確認
   - 法的文書の条項確認（Terms）

2. **ナビゲーション検証**:

   - 内部リンクのhref属性確認
   - 外部リンクの属性確認（target="\_blank", rel="noopener noreferrer"）
   - フッターナビゲーションの動作確認

3. **構造検証**:

   - 適切な見出し構造（h1, h2, h3）
   - セマンティックHTML構造
   - アクセシビリティ対応

4. **データ構造検証**:
   - FAQのQ&A形式の構造確認
   - 利用規約の条項番号順確認
   - カテゴリ分けの妥当性確認

## フロントエンドテスト戦略

インテグレーションテストでは、以下の観点でフロントエンドのテストを強化しています：

1. **コンポーネントテスト**: 個々のUIコンポーネントの動作検証
2. **フォームバリデーション**: 入力検証ロジックのテスト
3. **ユーザーインタラクション**: クリック、入力、送信などのユーザー操作のシミュレーション
4. **状態管理**: コンポーネント間の状態共有と更新のテスト
5. **レンダリング**: 条件付きレンダリングと動的コンテンツのテスト
6. **エラーハンドリング**: エラー状態の表示と処理のテスト
7. **レスポンシブ対応**: モバイル・デスクトップでの表示確認
8. **SEO対応**: メタデータとリンク構造の検証

## テスト作成のガイドライン

新しいテストを追加する際は、以下のガイドラインに従ってください：

1. **テスト分類**: 適切なディレクトリ（unit/integration）にテストを配置
2. **命名規則**: テストファイル名は対象の機能名に合わせる（例: `login.test.tsx`）
3. **テスト構造**: `describe`と`it`を使用して階層的に構造化
4. **アサーション**: 明確で具体的なアサーションを使用
5. **モック**: 外部依存はモック化して分離テスト
6. **ユーザー視点**: 実際のユーザー操作を模倣したテストを作成

## 静的ページテストのベストプラクティス

1. **コンテンツ確認**:

   - 重要なテキストの存在確認は正規表現を活用
   - ページ固有のコンテンツを重点的にテスト
   - ユーザーにとって重要な情報の表示確認

2. **リンク検証**:

   - 全てのリンクのhref属性を確認
   - 外部リンクのセキュリティ属性確認
   - 内部ナビゲーションの整合性確認

3. **構造検証**:

   - 見出し階層の論理性確認
   - セマンティックHTMLの使用確認
   - アクセシビリティガイドラインの遵守確認

4. **メンテナンス性**:
   - テストは実装詳細ではなく、ユーザー体験に焦点
   - 頻繁に変更される詳細な文言は避ける
   - 重要な機能とコンテンツに焦点を絞る

## フロントエンドテストのベストプラクティス

1. **セレクタの優先順位**:

   - ユーザーが見える要素を優先（テキスト、ラベル、役割）
   - データ属性（`data-testid`）は最後の手段として使用

2. **ユーザー操作のシミュレーション**:

   - `userEvent`を使用して実際のユーザー操作を模倣
   - 単純なイベント発火よりも実際の操作を優先

3. **非同期処理の扱い**:

   - `waitFor`や`findBy*`を使用して非同期更新を待機
   - タイムアウトは適切に設定

4. **テストの独立性**:

   - 各テストは独立して実行できるようにする
   - テスト間で状態が漏れないようにする

5. **スナップショットテスト**:
   - 大きなコンポーネントツリーではなく、小さなコンポーネントに対して使用
   - 頻繁に変更される部分には使用しない
